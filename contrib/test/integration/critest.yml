---

- name: enable and start CRI-O
  systemd:
    name: crio
    state: started
    enabled: yes
    daemon_reload: yes

- name: Flush the iptables
  command: iptables -F

- name: Enable localnet routing
  command: sysctl -w net.ipv4.conf.all.route_localnet=1

- name: Add masquerade for localhost
  command: iptables -t nat -I POSTROUTING -s 127.0.0.1 ! -d 127.0.0.1 -j MASQUERADE

- name: run critest validation
  shell: "critest --runtime-endpoint /var/run/crio/crio.sock --image-endpoint /var/run/crio/crio.sock v"
  args:
    chdir: "{{ ansible_env.GOPATH }}/src/github.com/cri-o/cri-o"
  async: 5400
  poll: 30
  when: ansible_distribution not in ['RedHat', 'CentOS']

# SELinux now breaks the tests. Not sure why. The branch is too old to be worth figuring out why
# runtime should support port mapping with host port and container port seems to be broken because of ipv6
- block:

    - name: Disable selinux during integration tests
      command: 'setenforce 0'
      when: not integration_selinux_enabled

    - name: run critest validation

      shell: "critest --runtime-endpoint /var/run/crio/crio.sock --image-endpoint /var/run/crio/crio.sock --ginkgo.skip='should not allow privilege escalation when true|runtime should support port mapping with host port and container port'"
      args:
        chdir: "{{ ansible_env.GOPATH }}/src/github.com/cri-o/cri-o"
      async: 5400
      poll: 30
      when: ansible_distribution in ['RedHat', 'CentOS']

  always:

    - name: Re-enable SELinux after integration tests
      command: 'setenforce 1'

- name: run critest benchmarks
  shell: "critest --runtime-endpoint /var/run/crio/crio.sock --image-endpoint /var/run/crio/crio.sock --benchmark"
  args:
    chdir: "{{ ansible_env.GOPATH }}/src/github.com/cri-o/cri-o"
  async: 5400
  poll: 30
